# ===========================================
# LeForge - Single Container Architecture
# ===========================================
# Everything runs in one container:
#   - Node.js app (Fastify + React)
#   - Embedded PostgreSQL + pgvector
#   - Embedded Redis
#   - Supervisord process manager
#
# Additional containers are ONLY for plugins.
#
# Usage:
#   docker compose up -d
# ===========================================

name: leforge

services:
  # ===========================================
  # LeForge Core - All-in-one container
  # ===========================================
  leforge:
    build:
      context: ./app
      dockerfile: Dockerfile
    image: leforge:latest
    container_name: leforge
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 4000
      
      # Embedded PostgreSQL (inside container via supervisord)
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_USER: leforge
      POSTGRES_PASSWORD: leforge_password
      POSTGRES_DB: leforge
      
      # Docker socket for plugin container management
      DOCKER_SOCKET_PATH: /var/run/docker.sock
      DOCKER_NETWORK: leforge-network
      
      # Plugin port allocation
      PLUGIN_PORT_RANGE_START: ${PLUGIN_PORT_START:-4001}
      PLUGIN_PORT_RANGE_END: ${PLUGIN_PORT_END:-4999}
      
      # Embedded Gateway Settings
      GATEWAY_ENABLED: "true"
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      
      # Auth settings
      API_KEY_ENABLED: "true"
      JWT_ENABLED: "false"
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production-min-32-chars}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # Local LLM Gateway URLs (Docker network hostnames for plugin containers)
      OLLAMA_URL: "http://forgehook-ollama-local:11434"
      LMSTUDIO_URL: "http://forgehook-lm-studio:1234/v1"
      
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - leforge_data:/app/data
      - leforge_postgres:/var/lib/postgresql/data
    ports:
      - "${APP_PORT:-4000}:4000"
      - "${APP_HTTPS_PORT:-4443}:4443"
    networks:
      leforge-network:
        aliases:
          - leforge-app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

# ===========================================
# Networks
# ===========================================
networks:
  leforge-network:
    driver: bridge
    name: leforge-network

# ===========================================
# Volumes
# ===========================================
volumes:
  leforge_data:
    name: leforge-data
    external: true
  leforge_postgres:
    name: leforge-embedded-postgres
    external: true
