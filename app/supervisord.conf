[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisor/supervisord.pid
childlogdir=/var/log/supervisor
user=root

[unix_http_server]
file=/var/run/supervisor/supervisor.sock

[supervisorctl]
serverurl=unix:///var/run/supervisor/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# =============================================================================
# PostgreSQL - Embedded Database
# =============================================================================
[program:postgres-init]
command=/bin/sh -c "if [ ! -f /var/lib/postgresql/data/PG_VERSION ]; then su postgres -c 'initdb -D /var/lib/postgresql/data'; fi"
autostart=true
autorestart=false
startsecs=0
priority=5
stdout_logfile=/var/log/supervisor/postgres-init.log
stderr_logfile=/var/log/supervisor/postgres-init-error.log

[program:postgres]
command=/usr/bin/postgres -D /var/lib/postgresql/data -c listen_addresses=* -c max_connections=100
user=postgres
autostart=true
autorestart=true
priority=10
startsecs=5
stdout_logfile=/var/log/supervisor/postgres.log
stderr_logfile=/var/log/supervisor/postgres-error.log
stdout_logfile_maxbytes=50MB
stderr_logfile_maxbytes=50MB

[program:postgres-setup]
command=/bin/sh -c "sleep 8 && su postgres -c \"psql -tc \\\"SELECT 1 FROM pg_roles WHERE rolname='leforge'\\\" | grep -q 1 || psql -c \\\"CREATE USER leforge WITH PASSWORD 'leforge_password' SUPERUSER;\\\"\" && su postgres -c \"psql -tc \\\"SELECT 1 FROM pg_database WHERE datname='leforge'\\\" | grep -q 1 || psql -c \\\"CREATE DATABASE leforge OWNER leforge;\\\"\""
autostart=true
autorestart=false
startsecs=0
priority=15
stdout_logfile=/var/log/supervisor/postgres-setup.log
stderr_logfile=/var/log/supervisor/postgres-setup-error.log

# =============================================================================
# Redis - Embedded Cache & Queue
# =============================================================================
[program:redis]
command=/usr/bin/redis-server --bind 0.0.0.0 --port 6379 --dir /var/lib/redis --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
user=nodejs
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/supervisor/redis.log
stderr_logfile=/var/log/supervisor/redis-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

# =============================================================================
# Node.js - LeForge Application
# =============================================================================
[program:nodejs]
command=/bin/sh -c "sleep 15 && /usr/local/bin/node /app/dist/server/index.js"
directory=/app
user=root
environment=NODE_ENV="production",HOME="/app",POSTGRES_HOST="localhost",POSTGRES_PORT="5432",POSTGRES_USER="leforge",POSTGRES_PASSWORD="leforge_password",POSTGRES_DB="leforge",REDIS_HOST="localhost",REDIS_PORT="6379"
autostart=true
autorestart=true
priority=50
startsecs=20
startretries=5
stdout_logfile=/var/log/supervisor/nodejs.log
stderr_logfile=/var/log/supervisor/nodejs-error.log
stdout_logfile_maxbytes=50MB
stderr_logfile_maxbytes=50MB
